{% extends "blog/base.html" %}
{% block title %}Home - The Byline{% endblock %}

{% block content %}

<!-- üèè Live Scores at Top -->
<section class="mb-10">
  <h2 class="text-xl font-bold text-gray-800 font-merriweather mb-4">üèè Live Cricket Scores</h2>
  <div id="cricket-live" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm text-gray-700 font-roboto">
    <p>Loading scores...</p>
  </div>
</section>

<!-- thanks for submitting email -->
{% if messages %}
{% for message in messages %}
<div class="mb-4 px-4 py-3 bg-green-100 text-green-800 rounded-lg shadow-sm">
  {{ message }}
</div>
{% endfor %}
{% endif %}


<!-- Main Content Grid: Articles + Opinions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

  <!-- LEFT: Article Feed -->
  <div class="lg:col-span-2">
    <h2 class="text-3xl font-playfair text-gray-900 mb-6 border-b-2 border-blue-600 pb-2">
      {% if current_category %}
      {{ current_category }} News
      {% else %}
      Latest News
      {% endif %}
    </h2>

    {% if articles %}
    <!-- Grid of Articles -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% for article in articles %}
      <div class="bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition-all">
        {% if article.image %}
        <img src="{{ article.image.url }}" alt="{{ article.title }}" class="w-full h-48 object-cover">
        {% endif %}
        <div class="p-4">
          <h3 class="text-lg font-playfair font-semibold text-gray-900 hover:text-blue-700 transition">
            <a href="{% url 'article_detail' slug=article.slug %}">{{ article.title }}</a>
          </h3>
          <p class="text-sm text-gray-600 mt-2">{{ article.summary|truncatechars:120 }}</p>
          <a href="{% url 'article_detail' slug=article.slug %}"
             class="text-blue-600 hover:text-blue-800 text-sm font-medium mt-3 inline-block">
            Read more ‚Üí
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500 text-sm">No articles available at the moment.</p>
    {% endif %}
  </div>

  

  <!-- RIGHT: Opinion Articles -->
  <div>
    <form method="GET" action="{% url 'home' %}" class="mb-6">
      <input
        type="text"
        name="q"
        placeholder="Search articles..."
        value="{{ search_query }}"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:border-blue-400"
      />
    </form>
    
    <h2 class="text-2xl font-bold mb-4 border-b-2 border-purple-700 pb-2">Opinion Articles</h2>
    <div class="space-y-5">
      {% for opinion in opinion_articles %}
      <div class="bg-white p-4 rounded-xl shadow flex items-start gap-4 hover:shadow-md transition">
        {% if opinion.authorImage %}
        <img src="{{ opinion.authorImage.url }}" alt="{{ opinion.author }}"
             class="w-12 h-12 rounded-full object-cover">
        {% endif %}
        <div>
          <h4 class="font-semibold text-gray-900">{{ opinion.title }}</h4>
          <p class="text-sm text-gray-500 mb-1">By {{ opinion.author }}</p>
          <p class="text-sm text-gray-600">{{ opinion.snippet|truncatewords:15 }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>


</div>


<section class="bg-gray-100 py-10 px-4 rounded-lg mt-8 max-w-2xl mx-auto">
  <h2 class="text-xl font-bold mb-4 text-gray-800">Get the best of Business & Sports in your inbox.</h2>

    <form method="POST" class="space-y-4 flex justify-between">
      {% csrf_token %}
      {{ form.email }}

      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 mx-4 rounded">
        Subscribe
      </button>
    </form>
  

  <ul class="mt-6 list-none list-inside text-sm text-gray-700 flex  justify-evenly">
    <li><strong>Weekly summaries</strong></li>
    <li><strong>Hand-picked reads</strong></li>
    <li><strong>No spam, Ever</strong></li>
  </ul>
</section>

<!-- üèè Cricket Scores Script -->
<script>
  let apiCallCount = 0;
  let hasFetchedOnce = false;

  async function fetchCricketLiveScores(force = false) {
    if (hasFetchedOnce && !force) return;
    apiCallCount++;
    hasFetchedOnce = true;

    try {
      const res = await fetch("https://cricbuzz-cricket.p.rapidapi.com/matches/v1/recent", {
        method: "GET",
        headers: {
          "X-RapidAPI-Key": "{{ RAPIDAPI_KEY }}",
          "X-RapidAPI-Host": "cricbuzz-cricket.p.rapidapi.com"
        }
      });

      const data = await res.json();
      const container = document.getElementById("cricket-live");
      container.innerHTML = "";

      const matches = data.typeMatches?.[0]?.seriesMatches?.flatMap(series =>
        series.seriesAdWrapper?.matches || []
      ).slice(0, 4);

      if (!matches?.length) {
        container.innerHTML = "<p>No live matches right now.</p>";
        return;
      }

      matches.forEach(match => {
        const info = match.matchInfo;
        const score = match.matchScore;

        const team1 = info?.team1?.teamName || "Team A";
        const team2 = info?.team2?.teamName || "Team B";
        const venue = info?.venueInfo?.ground || "Unknown venue";
        const status = score?.status || "Live";

        const t1Score = score?.team1Score?.inngs1;
        const t2Score = score?.team2Score?.inngs1;

        const formatScore = s => s ? `${s.runs}/${s.wickets} (${s.overs} ov)` : "N/A";

        const el = document.createElement("div");
        el.className = "border p-3 rounded bg-gray-50 shadow-sm";

        el.innerHTML = `
          <div class="font-semibold text-gray-800">${team1} vs ${team2}</div>
          <div class="text-sm text-gray-600 mb-1">${venue}</div>
          <div class="text-sm">
            <span class="font-medium text-blue-700">${team1}:</span> ${formatScore(t1Score)}<br>
            <span class="font-medium text-blue-700">${team2}:</span> ${formatScore(t2Score)}
          </div>
          <div class="mt-1 text-xs text-green-600 font-semibold">${status}</div>
        `;
        container.appendChild(el);
      });

    } catch (err) {
      console.error("API Error:", err);
      document.getElementById("cricket-live").innerHTML = "<p class='text-red-600'>Unable to fetch scores.</p>";
    }
  }

  function isVisible(elem) {
    const rect = elem.getBoundingClientRect();
    return rect.top < window.innerHeight && rect.bottom > 0;
  }

  function checkAndFetchOnce() {
    const block = document.getElementById("cricket-live");
    if (block && isVisible(block)) {
      fetchCricketLiveScores();
      window.removeEventListener("scroll", checkAndFetchOnce);
    }
  }

  window.addEventListener("DOMContentLoaded", checkAndFetchOnce);
  window.addEventListener("scroll", checkAndFetchOnce);

  // Auto refresh every 60s
  setInterval(() => {
    fetchCricketLiveScores(true);
  }, 60000);
</script>

{% endblock %}