{% extends "blog/base.html" %}
{% block title %}Home - The Byline{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

  <!-- LEFT: Article Feed -->
  <div class="lg:col-span-2">
    <!-- Section Title -->
    <h2 class="text-3xl font-playfair text-gray-900 mb-6 border-b-2 border-blue-600 pb-2">
      {% if current_category %}
        {{ current_category }} News
      {% else %}
        Latest Articles
      {% endif %}
    </h2>

    {% if articles %}
      <!-- Featured Article -->
      <article class="bg-blue-50 border border-blue-200 p-5 rounded-lg shadow-sm mb-8">
        {% if articles.0.image %}
          <img src="{{ articles.0.image.url }}" alt="{{ articles.0.title }}" class="w-full h-56 object-cover rounded-lg mb-4">
        {% endif %}
        <h3 class="text-2xl font-bold text-blue-900 mb-2 font-playfair">
          <a href="{% url 'article_detail' slug=articles.0.slug %}">{{ articles.0.title }}</a>
        </h3>
        <p class="text-gray-700 mb-3">{{ articles.0.summary|truncatechars:150 }}</p>
        <a href="{% url 'article_detail' slug=articles.0.slug %}" class="text-blue-600 hover:text-blue-800 font-medium text-sm">Read Full ‚Üí</a>
      </article>

      <!-- Grid of Remaining Articles -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for article in articles|slice:"1:" %}
        <article class="bg-white rounded-lg shadow hover:shadow-md transition overflow-hidden">
          {% if article.image %}
            <img src="{{ article.image.url }}" alt="{{ article.title }}" class="w-full h-48 object-cover">
          {% else %}
            <img src="https://via.placeholder.com/640x360?text=No+Image" alt="No image" class="w-full h-48 object-cover">
          {% endif %}
          <div class="p-5">
            <h3 class="text-xl font-semibold font-playfair text-gray-900 mb-1 hover:text-blue-600 transition">
              <a href="{% url 'article_detail' slug=article.slug %}">{{ article.title }}</a>
            </h3>
            {% if article.category %}
              <span class="text-xs inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded mb-2">{{ article.category }}</span>
            {% endif %}
            <p class="text-sm text-gray-600 mb-3">{{ article.summary|truncatechars:100 }}</p>
            <a href="{% url 'article_detail' slug=article.slug %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Read more ‚Üí</a>
          </div>
        </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 text-sm">No articles available at the moment.</p>
    {% endif %}
  </div>

  <!-- RIGHT: Live Cricket Scores -->
<aside class="bg-white rounded-lg shadow-md p-6 h-fit border-t-4 border-blue-600">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-bold text-gray-800 font-merriweather">üèè Live Cricket</h3>
    <button onclick="fetchCricketLiveScores(true)" class="text-blue-600 text-sm hover:underline">‚Üª Refresh</button>
  </div>
  <div id="cricket-live" class="space-y-3 text-sm text-gray-700 font-roboto">
    <p>Loading scores...</p>
  </div>
</aside>

<script>
  let apiCallCount = 0;
  let hasFetchedOnce = false;

  async function fetchCricketLiveScores(force = false) {
    // Only count actual API hits
    if (hasFetchedOnce && !force) return;

    apiCallCount++;
    console.log(`[Cricket API] Actual Call #: ${apiCallCount} at ${new Date().toLocaleTimeString()}`);
    hasFetchedOnce = true;

    try {
      const res = await fetch("https://cricbuzz-cricket.p.rapidapi.com/matches/v1/recent", {
        method: "GET",
        headers: {
          "X-RapidAPI-Key": "c489f0782emsh54056c03d235332p1434c6jsn5bb97c803faa",
          "X-RapidAPI-Host": "cricbuzz-cricket.p.rapidapi.com"
        }
      });

      const data = await res.json();
      const container = document.getElementById("cricket-live");
      container.innerHTML = "";

      const matches = data.typeMatches?.[0]?.seriesMatches?.flatMap(series =>
        series.seriesAdWrapper?.matches || []
      ).slice(0, 4);

      if (!matches?.length) {
        container.innerHTML = "<p>No live matches right now.</p>";
        return;
      }

      matches.forEach(match => {
        const info = match.matchInfo;
        const score = match.matchScore;

        const team1 = info?.team1?.teamName || "Team A";
        const team2 = info?.team2?.teamName || "Team B";
        const venue = info?.venueInfo?.ground || "Unknown venue";
        const status = score?.status || "Live";

        const t1Score = score?.team1Score?.inngs1;
        const t2Score = score?.team2Score?.inngs1;

        const formatScore = s => s ? `${s.runs}/${s.wickets} (${s.overs} ov)` : "N/A";

        const el = document.createElement("div");
        el.className = "border p-3 rounded bg-gray-50 shadow-sm";

        el.innerHTML = `
          <div class="font-semibold text-gray-800">${team1} vs ${team2}</div>
          <div class="text-sm text-gray-600 mb-1">${venue}</div>
          <div class="text-sm">
            <span class="font-medium text-blue-700">${team1}:</span> ${formatScore(t1Score)}<br>
            <span class="font-medium text-blue-700">${team2}:</span> ${formatScore(t2Score)}
          </div>
          <div class="mt-1 text-xs text-green-600 font-semibold">${status}</div>
        `;
        container.appendChild(el);
      });

    } catch (err) {
      console.error("API Error:", err);
      document.getElementById("cricket-live").innerHTML = "<p class='text-red-600'>Unable to fetch scores.</p>";
    }
  }

  function isVisible(elem) {
    const rect = elem.getBoundingClientRect();
    return rect.top < window.innerHeight && rect.bottom > 0;
  }

  function checkAndFetchOnce() {
    const block = document.getElementById("cricket-live");
    if (block && isVisible(block)) {
      fetchCricketLiveScores();
      window.removeEventListener("scroll", checkAndFetchOnce);
    }
  }

  window.addEventListener("DOMContentLoaded", checkAndFetchOnce);
  window.addEventListener("scroll", checkAndFetchOnce);

  // Auto refresh every 60s
  setInterval(() => {
    fetchCricketLiveScores(true);
  }, 60000);
</script>
{% endblock %}
